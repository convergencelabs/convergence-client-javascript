<!DOCTYPE html>
<html>
<head>
  <title>ArcGIS JS Event Text</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=7, IE=9, IE=10">
  <!--The viewport meta tag is used to improve the presentation and behavior of the samples
    on iOS devices-->
  <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
  <title>ArcGIS Test</title>
  <link rel="stylesheet" href="http://js.arcgis.com/3.10/js/dojo/dijit/themes/nihilo/nihilo.css">
  <link rel="stylesheet" href="http://js.arcgis.com/3.10/js/esri/css/esri.css">

  <style>
    #mainWindow {
      font-family: sans-serif;
      height: 600px;
      width: 600px;
    }
    html, body {
      margin: 0;
      padding: 0;
    }
    #mainWindow {
      float: left;
    }
  </style>

  <script src="http://js.arcgis.com/3.10/"></script>


  <style type="text/css">
    .smallmap {
      width: 400px;
      height: 250px;
      border: 1px solid #ccc;
      margin-bottom: 20px;
      float: left;
    }
    .userInfo {
      margin-left: 10px;
      margin-bottom: 20px;
      float: left;
      height: 250px;
      width: 450px;
      border: 1px solid #ccc;
      position: relative;
    }
    .minimap {
      width: 100px;
      height: 100px;
      border: 1px solid #ccc;
      position: absolute;
      bottom: 0;
      left: 0;
    }
    .title {
      clear: both;
      background: gray;
      border: 1px solid darkgray;

    }
    .gm-style-cc {
      display: none;
    }

    img[src="http://maps.gstatic.com/mapfiles/api-3/images/google_white2_hdpi.png"] {
      display: none;
    }
  </style>
</head>
<body>



<div class="title">User 1 Map</div>
<div id="user1Map" class="smallmap"></div>
<div class="userInfo">
  <span>Extent: </span><span id="user1Extent"></span><br/>
  <span>Center: </span><span id="user1Center"></span><br/>
  <span>Zoom: </span><span id="user1Zoom"></span><br/>
  <span>Pointer: </span><span id="user1Pointer"></span><br/>
  <span>Mini Map: </span>
  <select id="user1UserSelect">
    <option value="none">None</option>
    <option value="user2">User 2</option>
    <option value="user3">User 3</option>
  </select><br/>
  <span>Linked Map: </span>
  <select id="user1LinkedUser">
    <option value="none">None</option>
    <option value="user2">User 2</option>
    <option value="user3">User 3</option>
  </select>
  <div id="user1MiniMap" class="minimap" style="visibility: hidden"></div>
</div>

<div class="title">User 2 Map</div>
<div id="user2Map" class="smallmap"></div>
<div class="userInfo">
  <span>Extent: </span><span id="user2Extent"></span><br/>
  <span>Center: </span><span id="user2Center"></span><br/>
  <span>Zoom: </span><span id="user2Zoom"></span><br/>
  <span>Pointer: </span><span id="user2Pointer"></span><br/>
  <span>Mini Map: </span>
  <select id="user2UserSelect">
    <option value="none">None</option>
    <option value="user1">User 1</option>
    <option value="user3">User 3</option>
  </select><br/>
  <span>Linked Map: </span>
  <select id="user2LinkedUser">
    <option value="none">None</option>
    <option value="user1">User 1</option>
    <option value="user3">User 3</option>
  </select>
  <div id="user2MiniMap" class="minimap" style="visibility: hidden"></div>
</div>

<div class="title">User 3 Map</div>
<div id="user3Map" class="smallmap"></div>
<div class="userInfo">
  <span>Extent: </span><span id="user3Extent"></span><br/>
  <span>Center: </span><span id="user3Center"></span><br/>
  <span>Zoom: </span><span id="user3Zoom"></span><br/>
  <span>Pointer: </span><span id="user3Pointer"></span><br/>
  <span>Mini Map: </span>
  <select id="user3UserSelect">
    <option value="none">None</option>
    <option value="user1">User 1</option>
    <option value="user2">User 2</option>
  </select><br/>
  <span>Linked User: </span>
  <select id="user3LinkedUser">
    <option value="none">None</option>
    <option value="user1">User 1</option>
    <option value="user2">User 2</option>
  </select>
  <div id="user3MiniMap" class="minimap" style="visibility: hidden"></div>
</div>

<script type="text/javascript">
  var user1Map;
  var user2Map;
  var user3Map;

  var user1 = {
    name: "User 1",
    id: "user1",
    oldExtent: null,
    center: [-118.2, 33.29],
    zoom: 4,
    extent: null,
    pointer: null,
    mainMap: null,
    miniMap: null,
    pointerLayer: null,
    color: "blue",
    userPointers: {},
    linkedUserId: null
  };

  var user2 = {
    name: "User 2",
    id: "user2",
    oldExtent: null,
    center: [-118.2, 33.29],
    zoom: 3,
    extent: null,
    pointer: null,
    mainMap: null,
    miniMap: null,
    pointerLayer: null,
    color: "red",
    userPointers: {},
    linkedUserId: null
  };

  var user3 = {
    name: "User 3",
    id: "user3",
    oldExtent: null,
    center: [110.47, 19.39],
    zoom: 3,
    extent: null,
    pointer: null,
    mainMap: null,
    miniMap: null,
    pointerLayer: null,
    color: "green",
    userPointers: {},
    linkedUserId: null
  };

  var users = [user1, user2, user3];

  require([
    "esri/map",
    "esri/toolbars/edit",
    "esri/graphic",

    "esri/geometry/Polyline",
    "esri/geometry/Polygon",

    "esri/symbols/SimpleLineSymbol",
    "esri/symbols/SimpleFillSymbol",
    "esri/geometry/Point",
    "esri/geometry/webMercatorUtils",

    "dojo/_base/event",
    "dojo/parser",
    "dojo/dom",
    "dojo/dom-style",
    "dijit/registry",
    "dijit/Menu",
    "esri/layers/KMLLayer",
    "dojo/_base/Color",
    "dojo/_base/connect",

    "dijit/form/ToggleButton",
    "dijit/form/DropDownButton",
    "dijit/CheckedMenuItem",
    "dijit/layout/BorderContainer",
    "dijit/layout/ContentPane",
    "dojo/domReady!"
  ], function(
      Map, Edit, Graphic,
      Polyline, Polygon,
      SimpleLineSymbol, SimpleFillSymbol, Point, webMercatorUtils,
      event, parser, dom, domStyle, registry, Menu, KMLLayer, Color, connect
  ) {

    var initColor = "#ce641d";
    var pointerPath = "m 75.300095,89.125 c -2.5188,0 -5.03,0 -7.55,0.025 -0.36,57.61001 -0.14488,115.23998 -0.22504,172.85 0.11024,30.56004 -0.21968,61.12498 0.2,91.675 10.37032,-0.01 20.74008,0.08 31.1,0 0.27744,-4.44488 0.348,-8.93234 0.35008,-13.425 l 0,-2.025 2.024965,0.025 c 4.40976,0.0289 8.81048,0.002 13.2,-0.05 0.10592,-4.5143 0.42376,-9.05769 -0.075,-13.575 l -0.27496,-2.525 2.52504,0.325 c 4.54232,0.57852 9.13448,0.197 13.67496,0.1 0.0866,-4.35032 0.1844,-8.70374 0.22504,-13.05 l 0.025,-2 2,0.025 c 3.43216,0.0267 6.87392,-0.0112 10.32496,-0.2 l 2.27504,-0.125 -0.17504,2.275 c -0.71368,9.51482 0.89384,19.03621 0.37504,28.55 4.48976,0.14849 8.97896,0.2084 13.47504,0.25 l 1.94992,0.025 0.025,1.95 c 0.0878,9.64042 0.0657,19.27631 0.22504,28.925 4.4364,0.087 8.87376,0.1386 13.32496,0.15 l 1.97504,0 0.025,1.975 c 0.0801,4.49655 0.11752,8.96595 0.1,13.475 10.43992,0.14 20.88512,0.11 31.32496,0.05 0.37624,-4.42817 0.5416,-8.91848 0.22504,-13.425 l -0.15,-2.2 2.2,0.05 c 4.42952,0.12337 8.8712,0.0862 13.25,-0.025 0.15,-10.38998 0.095,-20.78495 -0.025,-31.175 -4.46072,-0.12198 -8.91296,-0.1782 -13.37496,-0.225 l -1.95,-0.025 -0.025,-1.95 c -0.15104,-9.65978 -0.078,-19.28792 -0.12504,-28.95 -4.46824,-0.1639 -8.97896,-0.24806 -13.47496,-0.125 l -2.12504,0.05 0.075,-2.125 c 0.15224,-3.72234 0.2132,-7.43125 0.2,-11.125 l 0,-2 2,0 c 19.96048,-0.0353 39.9032,-0.0274 59.87504,-0.25 0.13008,-10.35002 0.16488,-20.69997 -0.025,-31.05 -4.49024,0 -8.97256,-0.0334 -13.45008,-0.1 l -1.94992,-0.025 -0.025,-1.95 c -0.065,-4.48808 -0.10104,-8.98374 -0.075,-13.475 -4.46624,-0.1132 -8.92296,-0.1394 -13.4,-0.15 l -1.97504,0 -0.025,-1.975 c -0.0491,-4.45188 -0.088,-8.89958 -0.17504,-13.35 -4.4552,-0.199 -8.93808,-0.3182 -13.45,-0.275 l -2.02504,0.025 0,-2.025 c -0.01,-4.50767 -0.031,-9.00584 -0.075,-13.5 -4.49248,0.0263 -8.99208,-0.009 -13.47496,-0.1 l -1.95008,-0.05 0,-1.95 c -0.0118,-4.41425 -0.0446,-8.8033 -0.17496,-13.2 -4.43424,-0.243 -8.87832,-0.2822 -13.35,-0.3 l -1.97504,0 -0.025,-1.975 c -0.0707,-4.49178 -0.1176,-8.96993 -0.1,-13.475 -4.49776,-0.0175 -8.98584,-0.0518 -13.47504,-0.125 l -1.9,-0.025 -0.075,-1.9 c -0.1608,-4.49031 -0.34096,-9.00011 -0.35,-13.5 -4.38576,-0.1042 -8.76824,-0.122 -13.17504,-0.125 l -1.94992,0 -0.0501,-1.95 c -0.1088,-4.4705 -0.1688,-8.96599 -0.12496,-13.45 -4.49192,-0.0524 -8.9856,-0.0844 -13.47504,-0.15 l -1.9,-0.025 -0.075,-1.9 c -0.17592,-4.48987 -0.24096,-8.98034 -0.25,-13.5 -4.46808,-0.1045 -8.92472,-0.1282 -13.4,-0.15 l -1.97504,0 -0.025,-1.975 c -0.0282,-4.4654 -0.0543,-8.94064 -0.15,-13.4 -4.48952,-0.0262 -9.0016,-0.0375 -13.5,-0.075 l -1.950005,-0.025 -0.02496,-1.95 c -0.04112,-4.47935 -0.066,-8.97978 -0.07504,-13.475 -4.49416,-0.1306 -9.02416,-0.1016 -13.55,-0.075 l -1.97496,0 -0.02504,-1.975 c -0.0284,-4.508216 -0.10856,-9.018512 -0.3,-13.5 -2.51496,-0.015 -5.03128,-0.025 -7.55,-0.025 z";


    function init() {
      user1Map = createMap(user1);
      user2Map = createMap(user2);
      user3Map = createMap(user3);
    }

    function createMap(user) {
      var map = new Map(user.id + 'Map', {
        basemap: "satellite",
        center: user.center,
        zoom: user.zoom,
        scrollWheelZoom: true,
        logo: false
      });

      var pointerLayer = new esri.layers.GraphicsLayer();
      map.addLayer(pointerLayer);
      user.pointerLayer  = pointerLayer;

      map.on("extent-change", extentChanged);
      function extentChanged(event){
        user.extent = event.extent;
        user.center = event.extent.getCenter();
        renderUserInfo(user);
        updateLinkedMaps(user);
        updateOverviewMaps();
      }

      map.on("zoom-end", zoomEnd);
      function zoomEnd(event) {
        user.zoom = event.level;
        renderUserInfo(user);
        updateLinkedMaps(user);
        updateOverviewMaps();
      }

      //map.on("pan-end", panEnd);
      map.on("pan", panEnd);
      function panEnd(event) {
        user.extent = event.extent;
        user.center = event.extent.getCenter();
        updateLinkedMaps(user);
        updateOverviewMaps();
      }

      var showCoordinates = function(evt) {
        user.pointer = webMercatorUtils.webMercatorToGeographic(evt.mapPoint);
        renderUserInfo(user);
        updateUserPointers(user);
        //the map is in web mercator but display coordinates in geographic (lat, long)
        //cursor.setGeometry(new Point([mp.x, mp.y]));
      };
      map.on("mouse-move", showCoordinates);

      map.on("mouse-out", function (event) {
        user.pointer = null;
        renderUserInfo(user);
        updateUserPointers(user);
      });


      var miniMap = new Map(user.id + 'MiniMap', {
        basemap: "satellite",
        center: user.center,
        zoom: user.zoom,
        scrollWheelZoom: true,
        logo: false
      });
      miniMap.disableMapNavigation();
      miniMap.hideZoomSlider();


      var userSelector = document.getElementById(user.id + 'UserSelect');
      userSelector.onchange = function (e) {
        updateOverviewMap(user);
      };

      var linkedSelector = document.getElementById(user.id + 'LinkedUser');
      linkedSelector.onchange = function (e) {
        hanldeLinkedUserChange(user);
      };

      user.mainMap = map;
      user.miniMap = miniMap;
      //user.extent = JSON.stringify(map.getExtent());
      renderUserInfo(user);
      return map;
    }

    function updateLinkedMaps(user) {
      updateLinkedMap(user1, user);
      updateLinkedMap(user2, user);
      updateLinkedMap(user3, user);
    }

    function updateLinkedMap(followingUser, linkedUser) {
      if (followingUser.linkedUserId == linkedUser.id) {
        followingUser.mainMap.centerAndZoom(linkedUser.extent.getCenter(), linkedUser.zoom);
      }
    }

    function updateUserPointers(user) {
      updateUserPointer(user1, user);
      updateUserPointer(user2, user);
      updateUserPointer(user3, user);
    }

    function updateUserPointer(receivingUser, eventUser) {
      if (receivingUser.id == eventUser.id) {
        return;
      }

      var pointer = eventUser.pointer;

      if (pointer != null) {
        // The user that generated the event has a non null pointer.
        if (receivingUser.userPointers[eventUser.id]) {
          // The receiving user already has a pointer for this user.
          // Just update the location.
          var point = new Point(pointer);
          var graphic = receivingUser.userPointers[eventUser.id];
          graphic.setGeometry(point);
        } else {
          var point = new Point(pointer);
          var pointer = new Graphic(point, createSymbol(pointerPath, eventUser.color));
          receivingUser.userPointers[eventUser.id] = pointer;
          receivingUser.pointerLayer.add(pointer);
        }
      } else {
        // We need to remove the graphic.
        if (receivingUser.userPointers[eventUser.id]) {
          var graphic = receivingUser.userPointers[eventUser.id];
          receivingUser.pointerLayer.remove(graphic);
          delete receivingUser.userPointers[eventUser.id]
        }
      }
    }

    function createSymbol(path, color){
      var markerSymbol = new esri.symbol.SimpleMarkerSymbol();
      markerSymbol.setPath(path);
      markerSymbol.setColor(new dojo.Color(color));
      markerSymbol.setOutline(null);
      markerSymbol.setOffset(4, -5);
      return markerSymbol;
    }

    function updateOverviewMaps() {
      updateOverviewMap(user1);
      updateOverviewMap(user2);
      updateOverviewMap(user3);
    }

    function hanldeLinkedUserChange(user) {
      var userSelector = document.getElementById(user.id + 'LinkedUser');
      var val = userSelector.value;

      if (val == 'none') {
        user.linkedUserId = null;
        user.mainMap.setExtent(user.oldExtent, true);
        user.mainMap.enableMapNavigation();
        user.mainMap.showZoomSlider();
      } else {
        user.oldExtent = user.mainMap.extent;
        user.linkedUserId = val;
        user.mainMap.disableMapNavigation();
        user.mainMap.hideZoomSlider();

        var center = null;
        var zoom = null;
        switch (val) {
          case "user1":
            center = user1.mainMap.extent.getCenter();
            zoom = user1.zoom;
            break;
          case "user2":
            center = user2.mainMap.extent.getCenter();
            zoom = user2.zoom;
            break;
          case "user3":
            center = user3.mainMap.extent.getCenter();
            zoom = user3.zoom;
            break;
        }

        user.mainMap.centerAndZoom(center, zoom);
      }
    }

    function updateOverviewMap(user) {
      var userSelector = document.getElementById(user.id + 'UserSelect');
      var val = userSelector.value;

      switch (val) {
        case "none":
          user.miniMap.setVisibility(false);
          break;
        case "user1":
          user.miniMap.setExtent(user1.extent, true);
          user.miniMap.setVisibility(true);
          break;
        case "user2":
          user.miniMap.setExtent(user2.extent, true);
          user.miniMap.setVisibility(true);
          break;
        case "user3":
          user.miniMap.setExtent(user3.extent, true);
          user.miniMap.setVisibility(true);
          break;
      }
    }

    function renderUserInfo(user) {
      var centerElement = document.getElementById(user.id + 'Center');
      centerElement.innerHTML = user.center;

      var zoomElement = document.getElementById(user.id + 'Zoom');
      zoomElement.innerHTML = user.zoom;

      var pointerElement = document.getElementById(user.id + 'Pointer');
      pointerElement.innerHTML = user.pointer;

      var extentElement = document.getElementById(user.id + 'Extent');
      extentElement.innerHTML = user.extent;
    }
    init();
  });
</script>
</body>
</html>